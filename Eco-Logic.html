<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Logic x S-Quant 整合平台</title>
    
    <!-- 1. 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 載入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* 頁面切換動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* 助理對話框動畫 */
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slideInUp 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 內嵌圖標庫 ---
        const IconBase = ({ children, size = 24, className = "", ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const Icons = {
            LayoutDashboard: (props) => <IconBase {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>,
            Leaf: (props) => <IconBase {...props}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 14 8 7 7 0 0 1-14 8z"/><path d="M8 21h4"/></IconBase>,
            Users: (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>,
            User: (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>,
            Truck: (props) => <IconBase {...props}><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></IconBase>,
            AlertTriangle: (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>,
            ShieldCheck: (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></IconBase>,
            Newspaper: (props) => <IconBase {...props}><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/><path d="M18 14h-8"/><path d="M15 18h-5"/><path d="M10 6h8v4h-8V6Z"/></IconBase>,
            BrainCircuit: (props) => <IconBase {...props}><path d="M12 4.5a2.5 2.5 0 0 0-4.96-.46 2.5 2.5 0 0 0-1.98 3 2.5 2.5 0 0 0-1.32 4.24 3 3 0 0 0 .34 5.58 2.5 2.5 0 0 0 2.96 3.08 2.5 2.5 0 0 0 4.91.05L12 20V4.5Z"/><path d="M16 8V5c0-1.1.9-2 2-2"/><path d="M12 13h4"/><path d="M12 18h6a2 2 0 0 1 2 2v1"/><path d="M12 8h8"/></IconBase>,
            MapPin: (props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>,
            TrendingUp: (props) => <IconBase {...props}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>,
            DollarSign: (props) => <IconBase {...props}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconBase>,
            Activity: (props) => <IconBase {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconBase>,
            FileText: (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>,
            Download: (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
            History: (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>,
            Lock: (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>,
            Eye: (props) => <IconBase {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            CheckCircle2: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>,
            MessageCircle: (props) => <IconBase {...props}><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></IconBase>,
            X: (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>,
            Send: (props) => <IconBase {...props}><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></IconBase>,
            ArrowRight: (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>
        };

        const { 
            LayoutDashboard, Leaf, Users, User, Truck, AlertTriangle, 
            ShieldCheck, Newspaper, BrainCircuit, MapPin, TrendingUp, 
            DollarSign, Activity, FileText, Download, History, Lock, Eye, CheckCircle2,
            MessageCircle, X, Send, ArrowRight
        } = Icons;


        // --- 模擬數據 ---

        const FLEET_DATA = [
            { id: 'V-8821', driver: '陳大明', status: 'moving', carbon: 12.5, fuel_score: 85, fatigue_risk: 'Low', compliance: 98, social_score: 85, location: '台北市內湖區', engine_hours: 1240, idle_hours: 45 },
            { id: 'V-9903', driver: '王小華', status: 'idle', carbon: 18.2, fuel_score: 62, fatigue_risk: 'High', compliance: 75, social_score: 62, location: '桃園市龜山區', engine_hours: 890, idle_hours: 120 },
            { id: 'V-7714', driver: '李志豪', status: 'moving', carbon: 14.1, fuel_score: 78, fatigue_risk: 'Medium', compliance: 88, social_score: 91, location: '新北市三重區', engine_hours: 1560, idle_hours: 60 },
        ];

        const NEWS_RISKS = [
            { id: 1, source: 'News API', title: '物流業工時新制上路，部分業者違規', risk_level: 'High', category: '勞動權益', date: '2025-10-24' },
            { id: 2, source: 'Internal Report', title: '龜山轉運站發生小型工安意外', risk_level: 'Medium', category: '職場安全', date: '2025-10-23' },
            { id: 3, source: 'Social Media', title: '網路論壇討論物流司機過勞問題', risk_level: 'Low', category: '品牌聲譽', date: '2025-10-22' },
        ];

        const AUDIT_REPORTS = [
            { id: 'R-2025-Q3-E', type: 'ISO 14064-1', title: '2025 Q3 溫室氣體盤查報告書', status: 'Ready', date: '2025-10-01', size: '2.4 MB' },
            { id: 'R-2025-Q3-S', type: 'SROI / HRDD', title: '2025 Q3 社會影響力與人權盡職調查報告', status: 'Ready', date: '2025-10-01', size: '1.8 MB' },
            { id: 'R-2025-RAW', type: 'Raw Data', title: '原始數據稽核底稿 (Raw Data Log)', status: 'Locked', date: '2025-10-01', size: '15.6 MB' },
        ];

        const AUDIT_TRAIL = [
            { id: 101, timestamp: '2025-10-24 14:30:22', user: 'System (IoT)', action: 'Data Ingest', details: 'V-9903 上傳急煞訊號 (G-Sensor > 2.5g)', hash: '0x8f...2a1' },
            { id: 102, timestamp: '2025-10-24 14:30:25', user: 'Vertex AI', action: 'Risk Calculation', details: '觸發疲勞風險規則：連續駕駛 > 4hr + 急煞', hash: '0x3b...9c4' },
            { id: 103, timestamp: '2025-10-25 09:15:00', user: 'John Doe (Manager)', action: 'Manual Review', details: '確認為有效風險事件，已指派輔導員', hash: '0x1d...5e2' },
        ];

        // --- 元件 ---

        const NavItem = ({ icon, label, active, onClick, highlight, colorClass }) => {
            const baseClass = highlight && active 
                ? 'bg-emerald-900/40 border-emerald-400 text-emerald-400' 
                : (active ? 'bg-slate-800 border-emerald-500 text-white' : 'border-transparent text-slate-400 hover:bg-slate-800 hover:text-white');
            
            return (
            <button 
                onClick={onClick}
                className={`w-full flex items-center gap-3 px-4 py-3 text-sm font-medium transition-colors border-l-4 ${baseClass}`}
            >
                {icon}
                {label}
            </button>
            );
        };

        const KpiCard = ({ title, value, trend, trendUp, icon, iconBgClass, iconColorClass, subtitle }) => (
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 p-6 hover:shadow-md transition-shadow">
                <div className="flex justify-between items-start mb-4">
                    <div className={`p-3 rounded-lg ${iconBgClass} ${iconColorClass}`}>
                        {icon}
                    </div>
                    {trend && (
                        <div className={`flex items-center gap-1 text-xs font-bold px-2 py-1 rounded-full ${trendUp ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'}`}>
                            {trendUp ? '↑' : '↓'} {trend}
                        </div>
                    )}
                </div>
                <div>
                    <p className="text-slate-500 text-xs uppercase tracking-wider font-semibold">{title}</p>
                    <h3 className="text-2xl font-bold text-slate-800 mt-1">{value}</h3>
                    {subtitle && <p className="text-xs text-slate-400 mt-2 flex items-center gap-1"><BrainCircuit size={12}/> {subtitle}</p>}
                </div>
            </div>
        );

        const StatusBadge = ({ status }) => {
            const styles = {
                moving: 'bg-emerald-50 text-emerald-700 border-emerald-200',
                idle: 'bg-amber-50 text-amber-700 border-amber-200',
                offline: 'bg-slate-100 text-slate-600 border-slate-200'
            };
            const labels = {
                moving: '行駛中',
                idle: '怠速中',
                offline: '離線'
            };
            return (
                <span className={`text-[10px] px-2 py-0.5 rounded-full border font-medium ${styles[status]}`}>
                {labels[status]}
                </span>
            );
        };

        // --- 系統助理元件 ---
        const SystemAssistant = () => {
            const [isOpen, setIsOpen] = useState(false);
            const [messages, setMessages] = useState([
                { id: 1, type: 'bot', text: '您好！我是 Eco-Logic 智能助理。請問有什麼我可以協助您的嗎？' }
            ]);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(scrollToBottom, [messages]);

            const handleQuestion = (question) => {
                const userMsg = { id: Date.now(), type: 'user', text: question };
                setMessages(prev => [...prev, userMsg]);

                let botResponseText = "";
                if (question.includes("查證連結")) {
                    botResponseText = "「查證連結」是一個專為第三方查證單位（如 SGS、BSI）生成的「唯讀（Read-Only）連結」。\n\n您可以將此連結寄給查證員，讓他們在遠端就能檢視原始數據來源（如 IoT 紀錄）與 AI 計算邏輯。這能大幅縮短現場查核的時間，也就是所謂的「數位化確信 (Digital Assurance)」。";
                } else if (question.includes("報告")) {
                    botResponseText = "您可以在「查證與報告中心」下載各類合規報告。目前支援 ISO 14064-1 溫室氣體盤查報告與 SROI 社會影響力報告。";
                } else if (question.includes("SROI")) {
                    botResponseText = "我們的 SROI 計算採用「避免成本法」與「財務代理變數」。\n我們不憑空估價，而是引用政府公開數據（如職災賠償金）與全球價值資料庫 (GVE)。\n您可以在「社會價值」頁面的駕駛分析報告中，查看每一筆計算的公式底稿。";
                } else if (question.includes("油耗")) {
                    botResponseText = "Eco-Score 油耗評分是根據急煞、急加速、怠速時間與引擎轉速等多重因子計算而成。\n\n若要改善評分，建議：\n1. 減少怠速超過 3 分鐘的情況。\n2. 保持平穩起步，避免大腳油門。";
                } else if (question.includes("頻率") || question.includes("更新")) {
                    botResponseText = "環境數據（碳排、油耗）為每 30 秒透過 IoT 車機回傳一次。\n社會價值評分（S-Quant）則為每日凌晨 02:00 進行批次運算更新，整合當日所有駕駛行為與外部輿情數據。";
                } else if (question.includes("降低碳排")) {
                    botResponseText = "建議可以透過以下方式降低碳排：\n1. 優化配送路線，減少行駛里程。\n2. 加強駕駛行為培訓，減少急煞與怠速。\n3. 定期保養車輛，確保引擎效率最佳化。";
                } else if (question.includes("法規")) {
                    botResponseText = "本平台目前支援以下法規標準：\n1. ISO 14064-1 (溫室氣體盤查)\n2. GRI 403 (職業健康與安全)\n3. 歐盟 CSDDD (企業永續盡職調查指令)\n我們也會持續更新以符合最新法規要求。";
                } else {
                    botResponseText = "收到您的詢問，我會盡快為您查詢相關資訊。";
                }

                setTimeout(() => {
                    setMessages(prev => [...prev, { id: Date.now() + 1, type: 'bot', text: botResponseText }]);
                }, 600);
            };

            return (
                <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end">
                    {isOpen && (
                        <div className="mb-4 w-80 bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden animate-slide-up flex flex-col h-96">
                            <div className="bg-slate-900 p-4 flex justify-between items-center text-white">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                    <span className="font-bold text-sm">Eco-Logic Assistant</span>
                                </div>
                                <button onClick={() => setIsOpen(false)} className="hover:bg-slate-700 p-1 rounded"><X size={16}/></button>
                            </div>
                            <div className="flex-1 p-4 overflow-y-auto bg-slate-50 space-y-3">
                                {messages.map(msg => (
                                    <div key={msg.id} className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[85%] rounded-2xl px-3 py-2 text-xs leading-relaxed whitespace-pre-wrap ${msg.type === 'user' ? 'bg-emerald-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none shadow-sm'}`}>
                                            {msg.text}
                                        </div>
                                    </div>
                                ))}
                                <div ref={messagesEndRef} />
                            </div>
                            <div className="p-3 bg-white border-t border-slate-100">
                                <div className="text-[10px] text-slate-400 mb-2 font-bold uppercase">常見問題</div>
                                <div className="flex flex-wrap gap-2">
                                    <button onClick={() => handleQuestion("什麼是產生查證連結？")} className="text-xs bg-slate-100 hover:bg-emerald-50 hover:text-emerald-700 text-slate-600 px-2 py-1 rounded-full border border-slate-200 transition-colors">什麼是查證連結？</button>
                                    <button onClick={() => handleQuestion("SROI 是怎麼算的？")} className="text-xs bg-slate-100 hover:bg-emerald-50 hover:text-emerald-700 text-slate-600 px-2 py-1 rounded-full border border-slate-200 transition-colors">SROI 是怎麼算的？</button>
                                    <button onClick={() => handleQuestion("如何改善油耗評分？")} className="text-xs bg-slate-100 hover:bg-emerald-50 hover:text-emerald-700 text-slate-600 px-2 py-1 rounded-full border border-slate-200 transition-colors">如何改善油耗？</button>
                                    <button onClick={() => handleQuestion("數據多久更新一次？")} className="text-xs bg-slate-100 hover:bg-emerald-50 hover:text-emerald-700 text-slate-600 px-2 py-1 rounded-full border border-slate-200 transition-colors">數據更新頻率？</button>
                                    <button onClick={() => handleQuestion("如何降低碳排？")} className="text-xs bg-slate-100 hover:bg-emerald-50 hover:text-emerald-700 text-slate-600 px-2 py-1 rounded-full border border-slate-200 transition-colors">如何降低碳排？</button>
                                    <button onClick={() => handleQuestion("系統支援哪些法規？")} className="text-xs bg-slate-100 hover:bg-emerald-50 hover:text-emerald-700 text-slate-600 px-2 py-1 rounded-full border border-slate-200 transition-colors">支援哪些法規？</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className="w-14 h-14 bg-emerald-600 hover:bg-emerald-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all hover:scale-105 active:scale-95"
                    >
                        {isOpen ? <X size={24} /> : <MessageCircle size={28} />}
                    </button>
                </div>
            );
        };

        // --- 主程式 ---

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedVehicle, setSelectedVehicle] = useState(FLEET_DATA[1]);
            const [isAiScanning, setIsAiScanning] = useState(false);
            const [socialScore, setSocialScore] = useState(78);
            const [detailModalOpen, setDetailModalOpen] = useState(false); // 控制環境數據詳情 Modal
            const [socialModalOpen, setSocialModalOpen] = useState(false); // 控制社會價值詳情 Modal

            // 計算車隊平均油耗評分
            const fleetAverageFuelScore = useMemo(() => {
                const total = FLEET_DATA.reduce((sum, vehicle) => sum + vehicle.fuel_score, 0);
                return total / FLEET_DATA.length;
            }, []);

            const handleAiScan = () => {
                setIsAiScanning(true);
                setTimeout(() => {
                    setIsAiScanning(false);
                    setSocialScore(82);
                    alert("Vertex AI 分析完成：已更新供應鏈人權風險指數，並納入最新工安報告。");
                }, 2000);
            };

            const handleDownload = (report) => {
                let content = "";
                let filename = `${report.title || 'Report'}.txt`;

                // 根據不同的報告類型，生成模擬內容
                if (report.type === 'ISO') {
                    content = `
==================================================
Eco-Logic | ISO 14064-1 溫室氣體盤查報告 (模擬)
==================================================
產生日期: ${new Date().toLocaleString()}
查證狀態: 系統初核通過

[Scope 1 直接排放]
柴油燃燒: 1,240.5 kgCO2e
  - 車輛 V-8821: 320.1 kg
  - 車輛 V-9903: 240.8 kg
  - 車輛 V-7714: 385.2 kg

[Scope 2 間接排放]
電力使用: 850.2 kgCO2e

[數據完整性]
資料來源: IoT 車機直連
雜湊值 (Hash): ${AUDIT_TRAIL[0].hash}
                    `.trim();
                } else if (report.type === 'SROI' || report.title.includes('人權')) {
                    content = `
==================================================
Eco-Logic | SROI 與 人權盡職調查報告 (模擬)
==================================================
產生日期: ${new Date().toLocaleString()}

[外部人權風險快訊]
事件：${NEWS_RISKS[0].title}
來源：${NEWS_RISKS[0].source}
風險等級：${NEWS_RISKS[0].risk_level}
AI 建議：建議針對外包物流商進行勞動條件稽核。

[社會投資報酬率 (SROI)]
投入：NT$ 1,200,000 (安駕培訓系統)
產出：事故率降低 15%，減少社會成本 NT$ 4,224,000
SROI 比率：3.52

[工時合規分析]
全體合規率：98.5%
異常事件：V-9903 (疲勞駕駛風險高)
                    `.trim();
                } else if (report.type === 'DriverDetail') {
                    content = `
==================================================
Eco-Logic | 單一車輛環境數據報告
==================================================
車輛編號: ${selectedVehicle.id}
駕駛姓名: ${selectedVehicle.driver}
位置: ${selectedVehicle.location}
日期: ${new Date().toLocaleString()}

[行駛數據]
總引擎運轉時數: ${selectedVehicle.engine_hours} hr
怠速時數: ${selectedVehicle.idle_hours} hr (佔比 ${(selectedVehicle.idle_hours/selectedVehicle.engine_hours*100).toFixed(1)}%)
平均油耗評分: ${selectedVehicle.fuel_score} / 100

[碳排放數據]
即時排放量: ${selectedVehicle.carbon} kgCO2e/hr
今日累計排放: ${(selectedVehicle.carbon * 8).toFixed(1)} kgCO2e

建議：該車輛怠速比例若過高，建議檢查引擎或調整路線規劃。
                    `.trim();
                } else if (report.type === 'SocialDetail') {
                    content = `
==================================================
Eco-Logic | 駕駛員社會績效分析報告 (S-Quant)
==================================================
車輛編號: ${selectedVehicle.id}
駕駛姓名: ${selectedVehicle.driver}
分析日期: ${new Date().toLocaleString()}

[AI 社會評分]
綜合得分: ${selectedVehicle.social_score} / 100
評級: ${selectedVehicle.social_score >= 80 ? '優良' : selectedVehicle.social_score >= 60 ? '普通' : '高風險'}

[SROI 透明計算底稿 - 避免成本法]
1. 成果：駕駛風險降低 (疲勞指數下降 30%)
   - 財務代理變數：避免之潛在肇事維修與賠償成本
   - 引用來源：保險局 112 年度營業用車輛平均理賠金額 (Ref: Insurance Bureau)
   - 計算：風險係數下降 x 平均賠償 $150,000 = 創造價值 $45,000

2. 成果：工時合規與身心健康
   - 財務代理變數：避免之人員流動與再招募培訓成本
   - 引用來源：勞動部 112 年度職類別薪資調查 (Ref: Ministry of Labor)
   - 計算：留任率提升 x 平均招募成本 $25,000 = 創造價值 $25,000

[關鍵指標]
1. 疲勞風險: ${selectedVehicle.fatigue_risk}
2. 工時合規性: ${selectedVehicle.compliance}%
3. 情緒穩定度: 穩定 (基於急煞/急轉彎數據推估)

建議：${selectedVehicle.fatigue_risk === 'High' ? '該駕駛疲勞風險偏高，請強制安排休息或進行面談。' : '表現良好，可作為優良駕駛範本。'}
                    `.trim();
                } else {
                    content = `[RAW DATA LOG] - RESTRICTED ACCESS\nTimestamp: ${new Date().toISOString()}\nUser: Auditor_Read_Only\n...\n`;
                }

                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // 車輛詳情 Modal (環境)
            const DriverDetailModal = () => {
                if (!detailModalOpen) return null;

                // 計算優於平均的百分比
                const diff = selectedVehicle.fuel_score - fleetAverageFuelScore;
                const percentDiff = (Math.abs(diff) / fleetAverageFuelScore * 100).toFixed(1);
                const isBetter = diff >= 0;

                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-fade-in">
                        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
                            <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                <div>
                                    <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                        <Truck className="text-emerald-600"/> {selectedVehicle.id} 環境數據監控
                                    </h3>
                                    <p className="text-sm text-slate-500 mt-1">駕駛：{selectedVehicle.driver} | 位置：{selectedVehicle.location}</p>
                                </div>
                                <button onClick={() => setDetailModalOpen(false)} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><X size={20}/></button>
                            </div>
                            
                            <div className="p-6 overflow-y-auto space-y-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                                        <p className="text-xs text-emerald-600 font-bold uppercase mb-1">Eco-Score</p>
                                        <p className="text-3xl font-bold text-emerald-700">{selectedVehicle.fuel_score}</p>
                                        <p className={`text-xs mt-1 ${isBetter ? 'text-emerald-600' : 'text-rose-500'}`}>
                                            {isBetter ? '優於' : '低於'}車隊平均 {percentDiff}%
                                        </p>
                                    </div>
                                    <div className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <p className="text-xs text-slate-500 font-bold uppercase mb-1">Carbon Emission</p>
                                        <p className="text-3xl font-bold text-slate-700">{selectedVehicle.carbon} <span className="text-sm font-normal">kg/hr</span></p>
                                    </div>
                                </div>

                                <div>
                                    <h4 className="font-bold text-slate-700 mb-3 flex items-center gap-2"><Activity size={16}/> 今日行程日誌 (Simulated Log)</h4>
                                    <div className="space-y-2">
                                        <div className="flex items-center gap-4 text-sm p-3 bg-white border border-slate-100 rounded-lg shadow-sm">
                                            <span className="font-mono text-slate-400 text-xs">08:30:00</span>
                                            <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs rounded font-bold">START</span>
                                            <span className="text-slate-600">引擎啟動，位置：內湖總部</span>
                                        </div>
                                        {/* ... logs ... */}
                                        <div className="flex items-center gap-4 text-sm p-3 bg-white border border-slate-100 rounded-lg shadow-sm">
                                            <span className="font-mono text-slate-400 text-xs">Now</span>
                                            <span className="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded font-bold">LIVE</span>
                                            <span className="text-slate-600">即時數據上傳中... Hash: 0x8a...9c</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                                <button onClick={() => setDetailModalOpen(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-200 rounded-lg text-sm font-medium">關閉</button>
                                <button 
                                    onClick={() => handleDownload({ title: `Driver_Env_Report_${selectedVehicle.id}`, type: 'DriverDetail' })} 
                                    className="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm"
                                >
                                    <Download size={16}/> 下載該司機個別報告
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            // 駕駛社會價值詳情 Modal (新增)
            const SocialDetailModal = () => {
                if (!socialModalOpen) return null;
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4 animate-fade-in">
                        <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
                            <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                <div>
                                    <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                        <User className="text-sky-600"/> S-Quant 駕駛個人分析報告
                                    </h3>
                                    <p className="text-sm text-slate-500 mt-1">分析對象：{selectedVehicle.driver} ({selectedVehicle.id})</p>
                                </div>
                                <button onClick={() => setSocialModalOpen(false)} className="p-2 hover:bg-slate-200 rounded-full transition-colors"><X size={20}/></button>
                            </div>
                            
                            <div className="p-6 overflow-y-auto space-y-6">
                                <div className="mb-2 flex items-center gap-6 p-4 bg-slate-50 rounded-xl border border-slate-100">
                                    <div className="w-16 h-16 rounded-full bg-white border border-slate-200 flex items-center justify-center text-2xl font-bold text-slate-600 shadow-sm">
                                        {selectedVehicle.driver[0]}
                                    </div>
                                    <div>
                                        <h4 className="font-bold text-lg text-slate-800">{selectedVehicle.driver}</h4>
                                        <p className="text-sm text-slate-500">車輛編號：{selectedVehicle.id}</p>
                                    </div>
                                    <div className="ml-auto text-right">
                                        <p className="text-xs text-slate-500 uppercase tracking-wider mb-1">綜合社會評分</p>
                                        <div className="flex items-baseline justify-end gap-1">
                                            <span className={`text-3xl font-bold ${selectedVehicle.social_score >= 80 ? 'text-emerald-600' : selectedVehicle.social_score >= 60 ? 'text-amber-500' : 'text-rose-500'}`}>{selectedVehicle.social_score}</span>
                                            <span className="text-sm text-slate-400">/100</span>
                                        </div>
                                    </div>
                                </div>

                                {/* SROI 透明計算底稿區塊 (回答老師質疑的關鍵) */}
                                <div className="bg-slate-50 rounded-xl border border-slate-200 p-5">
                                    <h4 className="font-bold text-slate-700 mb-3 text-sm flex items-center gap-2">
                                        <DollarSign size={16} className="text-indigo-600"/> SROI 價值轉換邏輯 (透明底稿)
                                    </h4>
                                    <div className="space-y-3">
                                        <div className="flex items-start gap-3 text-sm">
                                            <div className="mt-1 w-2 h-2 rounded-full bg-indigo-400 flex-shrink-0"></div>
                                            <div>
                                                <p className="text-slate-800 font-medium">成果：駕駛風險降低 (疲勞指數下降 30%)</p>
                                                <p className="text-slate-500 text-xs mt-0.5">財務代理：避免之潛在肇事維修與賠償成本</p>
                                                <p className="text-slate-400 text-[10px] mt-0.5">引用來源：保險局 112 年度營業用車輛平均理賠金額 (Ref: Insurance Bureau)</p>
                                            </div>
                                        </div>
                                        <div className="flex items-start gap-3 text-sm">
                                            <div className="mt-1 w-2 h-2 rounded-full bg-indigo-400 flex-shrink-0"></div>
                                            <div>
                                                <p className="text-slate-800 font-medium">成果：工時合規與身心健康</p>
                                                <p className="text-slate-500 text-xs mt-0.5">財務代理：避免之人員流動與再招募培訓成本</p>
                                                <p className="text-slate-400 text-[10px] mt-0.5">引用來源：勞動部 112 年度職類別薪資調查 (Ref: Ministry of Labor)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <div className="p-5 rounded-xl border border-slate-100 hover:border-slate-300 transition-colors">
                                        <div className="flex justify-between items-center mb-3">
                                            <span className="font-bold text-slate-700 flex items-center gap-2"><History size={18} className="text-slate-400"/> 工時合規性</span>
                                            <span className={`font-bold ${selectedVehicle.compliance < 90 ? 'text-rose-500' : 'text-emerald-600'}`}>{selectedVehicle.compliance}%</span>
                                        </div>
                                        <div className="w-full bg-slate-100 rounded-full h-2 mb-3">
                                            <div className={`${selectedVehicle.compliance < 90 ? 'bg-rose-500' : 'bg-emerald-500'} h-2 rounded-full`} style={{ width: `${selectedVehicle.compliance}%` }}></div>
                                        </div>
                                        <p className="text-sm text-slate-600 leading-relaxed">
                                            {selectedVehicle.compliance < 90 
                                                ? '警告：本週連續駕駛時數已接近法規上限，建議調整排班。' 
                                                : 'AI 分析顯示：根據打卡與 GPS 紀錄交叉比對，本週休息時間符合勞基法規範，無超時風險。'}
                                        </p>
                                    </div>
                                    
                                    <div className="p-5 rounded-xl border border-slate-100 hover:border-slate-300 transition-colors">
                                        <div className="flex justify-between items-center mb-3">
                                            <span className="font-bold text-slate-700 flex items-center gap-2"><Activity size={18} className="text-slate-400"/> 心理壓力與疲勞指數</span>
                                            <span className={`font-bold px-3 py-1 rounded-full text-xs ${selectedVehicle.fatigue_risk === 'High' ? 'bg-rose-100 text-rose-600' : selectedVehicle.fatigue_risk === 'Medium' ? 'bg-amber-100 text-amber-600' : 'bg-sky-100 text-sky-600'}`}>{selectedVehicle.fatigue_risk} Risk</span>
                                        </div>
                                        <p className="text-sm text-slate-600 leading-relaxed">
                                            {selectedVehicle.fatigue_risk === 'High'
                                                ? '偵測到頻繁急煞與不穩定轉向，AI 判定駕駛可能處於高疲勞或高壓力狀態，請立即介入關懷。'
                                                : 'G-Sensor 數據分析：急煞次數與轉彎平穩度處於正常範圍，判定駕駛情緒穩定。'}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                                <button onClick={() => setSocialModalOpen(false)} className="px-4 py-2 text-slate-500 hover:bg-slate-200 rounded-lg text-sm font-medium">關閉</button>
                                <button 
                                    onClick={() => handleDownload({ title: `Driver_Social_Report_${selectedVehicle.id}`, type: 'SocialDetail' })} 
                                    className="px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white rounded-lg text-sm font-medium flex items-center gap-2 shadow-sm"
                                >
                                    <Download size={16}/> 下載社會績效報告
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderContent = () => {
                switch(activeTab) {
                    case 'dashboard':
                        return (
                            <div className="animate-fade-in space-y-6">
                                {/* KPI 卡片區 */}
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                    <KpiCard 
                                        title="總碳排放量 (Scope 1)" 
                                        value="1,240 kgCO2e" 
                                        trend="5.2% 較上月" 
                                        trendUp={false} 
                                        icon={<Leaf />} 
                                        iconBgClass="bg-emerald-50"
                                        iconColorClass="text-emerald-600"
                                    />
                                    <KpiCard 
                                        title="社會與人權風險分" 
                                        value={`${socialScore}/100`} 
                                        trend="2.4分 較上月" 
                                        trendUp={true} 
                                        icon={<ShieldCheck />} 
                                        iconBgClass="bg-sky-50"
                                        iconColorClass="text-sky-600"
                                    />
                                     <KpiCard 
                                        title="SROI 社會投資報酬" 
                                        value="1 : 3.52" 
                                        trend="0.12 較上月" 
                                        trendUp={true} 
                                        icon={<TrendingUp />} 
                                        iconBgClass="bg-indigo-50" 
                                        iconColorClass="text-indigo-600"
                                    />
                                    <KpiCard 
                                        title="高風險駕駛行為" 
                                        value="12 件" 
                                        trend="3 件 較上月" 
                                        trendUp={false} 
                                        icon={<AlertTriangle />} 
                                        iconBgClass="bg-amber-50" 
                                        iconColorClass="text-amber-500"
                                    />
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* 近期系統警示 */}
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                        <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                            <Activity size={18} className="text-slate-500" /> 近期系統警示
                                        </h3>
                                        <div className="space-y-3">
                                            <div className="flex items-center justify-between p-3 border-l-4 border-rose-500 bg-white shadow-sm rounded-r-lg">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-rose-500"><AlertTriangle size={16}/></span>
                                                    <span className="text-sm font-medium text-slate-700">V-9903 觸發疲勞駕駛警示 (連續 4 小時)</span>
                                                </div>
                                                <span className="text-xs text-slate-400">14:30</span>
                                            </div>
                                            <div className="flex items-center justify-between p-3 border-l-4 border-amber-400 bg-white shadow-sm rounded-r-lg">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-amber-500"><AlertTriangle size={16}/></span>
                                                    <span className="text-sm font-medium text-slate-700">V-8821 怠速時間過長 (>15min)</span>
                                                </div>
                                                <span className="text-xs text-slate-400">11:15</span>
                                            </div>
                                        </div>
                                    </div>

                                    {/* 系統合規狀態 */}
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 flex flex-col justify-center items-center text-center shadow-sm">
                                        <div className="p-4 bg-slate-50 rounded-full mb-3">
                                            <ShieldCheck size={40} className="text-emerald-600" />
                                        </div>
                                        <h3 className="font-bold text-slate-800 text-lg">系統合規狀態</h3>
                                        <p className="text-sm text-slate-500 mt-2 max-w-xs">目前碳排數據 (ISO 14064) 與勞動合規數據 (GRI 403) 皆正常運作中。</p>
                                        <div className="mt-6 flex gap-3">
                                            <span className="px-3 py-1 bg-white border border-emerald-200 text-emerald-700 rounded-full text-xs font-bold shadow-sm">ISO 14064 Ready</span>
                                            <span className="px-3 py-1 bg-white border border-sky-200 text-sky-700 rounded-full text-xs font-bold shadow-sm">GRI Standards</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'environment':
                        return (
                            <div className="animate-fade-in space-y-6">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-xl font-bold text-slate-700">Carbon-V 車隊環境數據</h3>
                                    <div className="flex gap-2 text-sm text-slate-500">
                                        <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-emerald-500"></div> 正常</span>
                                        <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-amber-500"></div> 異常</span>
                                    </div>
                                </div>
                                <p className="text-sm text-slate-500 -mt-4 mb-2">點擊下方車輛卡片可查看詳細監控數據與下載個別報告。</p>
                                
                                <div className="grid grid-cols-1 gap-4">
                                    {FLEET_DATA.map((vehicle) => (
                                        <div 
                                            key={vehicle.id} 
                                            onClick={() => { setSelectedVehicle(vehicle); setDetailModalOpen(true); }} 
                                            className={`p-5 rounded-xl border bg-white cursor-pointer transition-all hover:shadow-md flex flex-col md:flex-row gap-6 items-center ${selectedVehicle.id === vehicle.id ? 'ring-2 ring-emerald-500 border-transparent' : 'border-slate-200'}`}
                                        >
                                            <div className="flex-1 w-full">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex items-center gap-4">
                                                        <div className="p-3 bg-slate-50 rounded-lg text-slate-500"><Truck size={24} /></div>
                                                        <div>
                                                            <div className="font-bold text-lg text-slate-800">{vehicle.id}</div>
                                                            <div className="text-xs text-slate-500 flex items-center gap-2 mt-1">
                                                                <span className="flex items-center gap-1"><Users size={12}/> {vehicle.driver}</span>
                                                                <span className="text-slate-300">|</span> 
                                                                <span className="flex items-center gap-1"><MapPin size={12}/> {vehicle.location}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <StatusBadge status={vehicle.status} />
                                                </div>
                                            </div>
                                            
                                            <div className="flex-1 w-full grid grid-cols-2 gap-8 border-t md:border-t-0 md:border-l border-slate-100 pt-4 md:pt-0 md:pl-8">
                                                <div>
                                                    <p className="text-xs text-slate-400 mb-1 uppercase tracking-wider">即時碳排放</p>
                                                    <p className="font-bold text-slate-800 text-lg">{vehicle.carbon} <span className="text-xs font-normal text-slate-500">kg/hr</span></p>
                                                </div>
                                                <div>
                                                    <p className="text-xs text-slate-400 mb-1 uppercase tracking-wider">油耗評分</p>
                                                    <div className="flex items-center gap-3">
                                                        <span className={`font-bold text-lg ${vehicle.fuel_score < 70 ? 'text-rose-500' : 'text-emerald-600'}`}>{vehicle.fuel_score}</span>
                                                        <div className="w-24 bg-slate-100 rounded-full h-2">
                                                            <div className={`h-2 rounded-full ${vehicle.fuel_score < 70 ? 'bg-rose-500' : 'bg-emerald-500'}`} style={{ width: `${vehicle.fuel_score}%` }}></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );

                    case 'social':
                        return (
                            <div className="animate-fade-in grid grid-cols-1 md:grid-cols-3 gap-6">
                                {/* 左側：改為駕駛列表 (與 Environment 類似，但顯示社會指標) */}
                                <div className="md:col-span-2 space-y-6">
                                    <div className="flex justify-between items-center">
                                        <h3 className="text-xl font-bold text-slate-700">駕駛社會績效列表</h3>
                                        <div className="flex gap-2 text-sm text-slate-500">
                                            <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-emerald-500"></div> 優良</span>
                                            <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-amber-500"></div> 普通</span>
                                            <span className="flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-rose-500"></div> 高風險</span>
                                        </div>
                                    </div>
                                    <p className="text-sm text-slate-500 -mt-4 mb-2">點擊下方駕駛卡片可查看 S-Quant 個人社會價值分析。</p>

                                    <div className="grid grid-cols-1 gap-4">
                                        {FLEET_DATA.map((vehicle) => (
                                            <div 
                                                key={vehicle.id} 
                                                onClick={() => { setSelectedVehicle(vehicle); setSocialModalOpen(true); }} 
                                                className={`p-5 rounded-xl border bg-white cursor-pointer transition-all hover:shadow-md flex flex-col md:flex-row gap-6 items-center ${selectedVehicle.id === vehicle.id ? 'ring-2 ring-sky-500 border-transparent' : 'border-slate-200'}`}
                                            >
                                                <div className="flex-1 w-full">
                                                    <div className="flex justify-between items-start">
                                                        <div className="flex items-center gap-4">
                                                            <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-lg font-bold text-slate-600">
                                                                {vehicle.driver[0]}
                                                            </div>
                                                            <div>
                                                                <div className="font-bold text-lg text-slate-800">{vehicle.driver}</div>
                                                                <div className="text-xs text-slate-500 flex items-center gap-2 mt-1">
                                                                    <span className="bg-slate-100 px-2 py-0.5 rounded">{vehicle.id}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <span className={`text-[10px] px-2 py-0.5 rounded-full border font-medium ${vehicle.fatigue_risk === 'High' ? 'bg-rose-50 text-rose-700 border-rose-200' : vehicle.fatigue_risk === 'Medium' ? 'bg-amber-50 text-amber-700 border-amber-200' : 'bg-emerald-50 text-emerald-700 border-emerald-200'}`}>
                                                            疲勞風險: {vehicle.fatigue_risk}
                                                        </span>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex-1 w-full grid grid-cols-2 gap-8 border-t md:border-t-0 md:border-l border-slate-100 pt-4 md:pt-0 md:pl-8">
                                                    <div>
                                                        <p className="text-xs text-slate-400 mb-1 uppercase tracking-wider">社會評分</p>
                                                        <p className={`font-bold text-lg ${vehicle.social_score >= 80 ? 'text-emerald-600' : vehicle.social_score >= 60 ? 'text-amber-500' : 'text-rose-500'}`}>{vehicle.social_score} <span className="text-xs font-normal text-slate-500">/ 100</span></p>
                                                    </div>
                                                    <div>
                                                        <p className="text-xs text-slate-400 mb-1 uppercase tracking-wider">合規率</p>
                                                        <div className="flex items-center gap-3">
                                                            <span className={`font-bold text-lg ${vehicle.compliance < 90 ? 'text-rose-500' : 'text-emerald-600'}`}>{vehicle.compliance}%</span>
                                                            <div className="w-24 bg-slate-100 rounded-full h-2">
                                                                <div className={`h-2 rounded-full ${vehicle.compliance < 90 ? 'bg-rose-500' : 'bg-emerald-500'}`} style={{ width: `${vehicle.compliance}%` }}></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* 右側：外部輿情風險 (維持不變) */}
                                <div className="space-y-6">
                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                                        <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2">
                                            <Newspaper className="text-slate-500" size={20} />
                                            外部人權風險快訊
                                        </h3>
                                        <div className="space-y-6">
                                            {NEWS_RISKS.map(news => (
                                                <div key={news.id} className="relative pl-4 border-l-2 border-slate-100 last:border-0">
                                                    <div className={`absolute -left-[5px] top-1.5 w-2.5 h-2.5 rounded-full border-2 border-white ${news.risk_level === 'High' ? 'bg-rose-500' : news.risk_level === 'Medium' ? 'bg-amber-400' : 'bg-emerald-400'}`}></div>
                                                    <div>
                                                        <h4 className="text-sm font-bold text-slate-800 leading-snug hover:text-sky-600 cursor-pointer transition-colors mb-1">{news.title}</h4>
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className="text-[10px] px-2 py-0.5 bg-slate-100 text-slate-600 rounded-full font-medium">{news.category}</span>
                                                            <span className="text-[10px] text-slate-400">{news.date}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <button 
                                            onClick={() => handleDownload({ title: '外部人權風險與輿情分析報告', type: 'SROI' })}
                                            className="w-full mt-6 py-2 text-xs font-medium text-slate-500 hover:text-slate-800 hover:bg-slate-50 rounded transition-colors border border-transparent hover:border-slate-200"
                                        >
                                            查看完整報告 &rarr;
                                        </button>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'reports':
                        return (
                            <div className="animate-fade-in space-y-8">
                                <section>
                                    <div className="flex justify-between items-end mb-6">
                                        <div>
                                            <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                                <FileText className="text-sky-600" /> 合規報告生成
                                            </h3>
                                            <p className="text-slate-500 text-sm mt-1">針對銀行 SLL 貸款與第三方查證單位所需的標準格式報告。</p>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        {AUDIT_REPORTS.map(report => (
                                            <div key={report.id} onClick={() => handleDownload({ title: report.title, type: report.type.includes('ISO') ? 'ISO' : 'SROI' })} className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all group cursor-pointer hover:-translate-y-1">
                                                <div className="flex justify-between items-start mb-4">
                                                    <span className="bg-slate-100 text-slate-600 text-xs px-2.5 py-1 rounded-md font-bold tracking-wide">{report.type}</span>
                                                    <div className="w-8 h-8 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                                                        <Download size={16} />
                                                    </div>
                                                </div>
                                                <h4 className="font-bold text-slate-800 mb-2 group-hover:text-sky-600 transition-colors">{report.title}</h4>
                                                <div className="flex items-center gap-2 text-xs text-slate-400">
                                                    <span>{report.date}</span>
                                                    <span>•</span>
                                                    <span>{report.size}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </section>

                                <section className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                    <div className="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                        <div>
                                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                                <History className="text-slate-500" /> 數據溯源與稽核軌跡
                                            </h3>
                                            <p className="text-xs text-slate-500 mt-1">
                                                符合 ISAE 3000 確信標準。紀錄所有數據的產生、AI 運算與人為修正歷程。
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200">
                                                <tr>
                                                    <th className="px-6 py-4">Timestamp</th>
                                                    <th className="px-6 py-4">Actor</th>
                                                    <th className="px-6 py-4">Action</th>
                                                    <th className="px-6 py-4">Details</th>
                                                    <th className="px-6 py-4">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {AUDIT_TRAIL.map(log => (
                                                    <tr key={log.id} className="hover:bg-slate-50 transition-colors">
                                                        <td className="px-6 py-4 font-mono text-slate-500 text-xs">{log.timestamp}</td>
                                                        <td className="px-6 py-4">
                                                            <span className={`px-2.5 py-1 rounded-full text-xs font-bold ${log.user.includes('System') || log.user.includes('AI') ? 'bg-purple-50 text-purple-700' : 'bg-blue-50 text-blue-700'}`}>
                                                                {log.user}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4 font-medium text-slate-800">{log.action}</td>
                                                        <td className="px-6 py-4 text-slate-600 max-w-xs truncate" title={log.details}>{log.details}</td>
                                                        <td className="px-6 py-4">
                                                            <span className="flex items-center gap-1.5 text-emerald-700 bg-emerald-50 px-2 py-0.5 rounded-full w-fit text-xs font-medium border border-emerald-100">
                                                                <CheckCircle2 size={12} /> Verified
                                                            </span>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            </div>
                        );
                    
                    default:
                        return null;
                }
            };

            const getPageTitle = () => {
                switch(activeTab) {
                    case 'dashboard': return 'ESG 綜合效益儀表板';
                    case 'environment': return '環境數據監控 (Environment)';
                    case 'social': return '社會價值評估 (Social)';
                    case 'reports': return '查證與報告中心';
                    default: return '';
                }
            };

            return (
                <div className="flex h-screen bg-slate-50 font-sans text-slate-800 overflow-hidden">
                {/* Sidebar */}
                <aside className="w-64 bg-slate-900 text-white flex flex-col shadow-2xl flex-shrink-0 z-20">
                    <div className="p-6 border-b border-slate-800">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-emerald-600 rounded-xl flex items-center justify-center font-bold text-2xl text-white shadow-lg shadow-emerald-900/50">E</div>
                        <div>
                        <h1 className="font-bold text-lg tracking-wide text-white">ECO-LOGIC</h1>
                        <p className="text-[10px] text-slate-400 uppercase tracking-widest mt-0.5">Carbon-V + S-Quant</p>
                        </div>
                    </div>
                    </div>

                    <nav className="flex-1 p-4 space-y-1.5 overflow-y-auto">
                    <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 px-3 mt-2">Core Modules</div>
                    <NavItem icon={<LayoutDashboard size={18} />} label="總覽儀表板" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
                    
                    <NavItem icon={<Truck size={18} />} label="環境數據 (Env)" active={activeTab === 'environment'} onClick={() => setActiveTab('environment')} />
                    
                    <NavItem icon={<Users size={18} />} label="社會價值 (Soc)" active={activeTab === 'social'} onClick={() => setActiveTab('social')} />
                    
                    <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-8 mb-3 px-3">Compliance</div>
                    <NavItem 
                        icon={<FileText size={18} />} 
                        label="查證與報告中心" 
                        active={activeTab === 'reports'} 
                        onClick={() => setActiveTab('reports')} 
                        highlight 
                        colorClass="text-sky-400 border-sky-400 bg-sky-900/20"
                    />
                    </nav>

                    <div className="p-4 border-t border-slate-800 bg-slate-900">
                    <div className="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-800 transition-colors cursor-pointer">
                        <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-emerald-500 to-sky-500 flex items-center justify-center text-xs font-bold shadow-md">JD</div>
                        <div className="overflow-hidden">
                        <p className="text-sm font-medium text-white truncate">John Doe</p>
                        <p className="text-xs text-slate-400 truncate">ESG Manager</p>
                        </div>
                    </div>
                    </div>
                </aside>

                {/* Main Content */}
                <main className="flex-1 overflow-y-auto relative scroll-smooth bg-slate-50">
                    {/* Header */}
                    <header className="bg-white/90 backdrop-blur-sm shadow-sm p-4 px-8 flex justify-between items-center sticky top-0 z-10 border-b border-slate-200">
                    <h2 className="text-xl font-bold text-slate-800 flex items-center gap-3">
                        {getPageTitle()}
                        {activeTab === 'reports' && <span className="text-[10px] bg-sky-50 text-sky-700 px-2.5 py-1 rounded-full border border-sky-100 font-bold uppercase tracking-wide">Auditor Mode</span>}
                    </h2>
                    <div className="flex gap-3">
                        <button 
                            onClick={handleAiScan}
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg text-white text-sm font-medium transition-all shadow-sm ${isAiScanning ? 'bg-slate-400 cursor-not-allowed' : 'bg-slate-800 hover:bg-slate-700 hover:shadow-md active:scale-95'}`}
                        >
                        {isAiScanning ? 'Processing...' : <><Lock size={14} /> 產生查證連結</>}
                        </button>
                    </div>
                    </header>

                    <div className="p-8 space-y-8 max-w-7xl mx-auto">
                        {renderContent()}
                    </div>
                </main>

                <DriverDetailModal />
                <SocialDetailModal />
                <SystemAssistant />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
